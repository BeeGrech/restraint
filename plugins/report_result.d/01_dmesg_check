#!/bin/sh

set -e
shopt -s nullglob

if [ ! -f /usr/share/restraint/plugins/helpers ]; then
    . ../helpers # For running tests
else
    . /usr/share/restraint/plugins/helpers
fi

PLUGIN=$(basename "$0")

if [ -z "$RSTRNT_RESULT_URL" ]; then
    rstrnt_crit "RSTRNT_RESULT_URL is not defined!"
    exit 1
fi

TMPDIR=$(mktemp -d)

clean_up() {
    rm -rf "$TMPDIR"
}
trap clean_up EXIT

DMESG_FILE=$TMPDIR/dmesg.log
OUTPUTFILE=$TMPDIR/outputfile.log

# Order of precedence for FAILURE & FALSESTRINGS:
# 1) Use User defined Task variable if present
# 2) else use content of failure or falsestrings files
# 3) else use hardcoded defaults.
FAILUREFILENM=${FAILUREFILENM:-"/usr/share/rhts/failurestrings"}
if [ ! -f ${FAILUREFILENM} ]; then
    FAILURESTRINGS=${FAILURESTRINGS:-"Oops|BUG|NMI appears to be stuck|Badness at"}
else
    # Remove space filled or empty lines and join lines with "|"
    FAILURESTRINGS=${FAILURESTRINGS:-$(sed '/^ *$/d' ${FAILUREFILENM} | paste -sd "|")}
fi

FALSEFILENM=${FALSEFILENM:-"/usr/share/rhts/falsestrings"}
if [ ! -f ${FALSEFILENM} ]; then
    FALSESTRINGS=${FALSESTRINGS:-"BIOS BUG|DEBUG|mapping multiple BARs.*IBM System X3250 M4"}
else
    # Remove space filled or empty lines and join lines with "|"
    FALSESTRINGS=${FALSESTRINGS:-$(sed '/^ *$/d' ${FALSEFILENM} | paste -sd "|")}
fi

# Dump dmesg output into $DMESG_FILE and clear it.
dmesg -c >"$DMESG_FILE"

# Submit dmesg log if any output
if [ -s "$DMESG_FILE" ]; then
    rstrnt-report-log --server "$RSTRNT_RESULT_URL" -l "$DMESG_FILE"
fi

# Move 'cut here' traces into their own numbered files trace-*.log
sed -n '/cut here/,/end trace/p;' "$DMESG_FILE" | \
    sed '/.*end trace.*/a\\' | \
    awk -v RS= -v TMPDIR="$TMPDIR" '{print > (TMPDIR"/trace-" NR ".log")}'

for TRACE in "$TMPDIR"/trace*; do
    if ! paste -s "$TRACE" | grep -q -P "$FALSESTRINGS" ; then
        cat "$TRACE" >> "$OUTPUTFILE"
    fi
done

# Remove all traces
sed -i -n '/cut here/,/end trace/!p;' "$DMESG_FILE"

# Check for errors
grep -C 5 -P '^(?:(?!'"$FALSESTRINGS"').)*('"$FAILURESTRINGS"')' "$DMESG_FILE" >> "$OUTPUTFILE"

if [ -s "$OUTPUTFILE" ]; then
    OUTPUTFILE=$OUTPUTFILE rstrnt-report-result --no-plugins "$TEST"/"$PLUGIN" FAIL 0
fi
